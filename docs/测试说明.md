# 测试说明文档

## 📋 测试概述

本项目采用MVVM架构，测试分为**单元测试**和**集成测试**两部分。

## 🧪 测试类型

### 1. 单元测试（Unit Tests）
**位置**: `app/src/test/java/`

单元测试在JVM上运行，不需要Android设备或模拟器，运行速度快。

#### 测试覆盖范围：
- ✅ **Content数据模型测试** (`ContentTest.kt`)
  - 测试 `hasVideo` 属性的各种情况
  - 测试数据模型的字段完整性
  - 测试数据相等性

- ✅ **ContentRepository测试** (`ContentRepositoryTest.kt`)
  - 测试数据获取功能
  - 测试返回数据的有效性
  - 测试数据唯一性
  - 测试视频相关数据

- ✅ **HomeViewModel测试** (`HomeViewModelTest.kt`)
  - 测试内容加载功能
  - 测试状态管理（loading、error）
  - 测试根据ID查找内容
  - 测试错误清除功能
  - 测试话题切换功能
  - 测试刷新和加载更多功能

- ✅ **TopicViewModel测试** (`TopicViewModelTest.kt`)
  - 测试话题列表加载
  - 测试话题选择功能
  - 测试选中话题获取

- ✅ **CommentViewModel测试** (`CommentViewModelTest.kt`)
  - 测试评论加载功能
  - 测试添加评论功能
  - 测试点赞功能

- ✅ **FavoriteViewModel测试** (`FavoriteViewModelTest.kt`)
  - 测试收藏功能（添加/取消收藏）
  - 测试浏览历史功能
  - 测试清空历史功能

- ✅ **FavoriteRepository测试** (`FavoriteRepositoryTest.kt`)
  - 测试收藏的增删查功能
  - 测试历史记录的增删查功能
  - 测试历史记录去重和限制数量

- ✅ **UserViewModel测试** (`UserViewModelTest.kt`)
  - 测试登录功能（成功和失败场景）
  - 测试注册功能（成功和失败场景）
  - 测试登出功能
  - 测试登录状态管理
  - 测试错误清除功能
  - 测试加载状态

### 2. 集成测试（Integration Tests）
**位置**: `app/src/androidTest/java/`

集成测试需要在Android设备或模拟器上运行，可以测试需要Android Context的功能。

#### 测试覆盖范围：
- ✅ **ResourceHelper测试** (`ResourceHelperTest.kt`)
  - 测试本地资源URI生成
  - 测试raw资源URI格式
  - 测试drawable资源URI格式
  - 测试不存在的资源处理

- ✅ **UI集成测试** (`HomeScreenTest.kt`)
  - 测试Compose UI组件显示
  - 测试加载状态显示

- ✅ **ProfileScreen测试** (`ProfileScreenTest.kt`)
  - 测试未登录状态显示
  - 测试登录/注册按钮显示
  - 测试设置选项显示

- ✅ **LoginScreen测试** (`LoginScreenTest.kt`)
  - 测试登录表单显示
  - 测试用户名和密码输入框显示

- ✅ **RegisterScreen测试** (`RegisterScreenTest.kt`)
  - 测试注册表单显示
  - 测试所有输入框显示

## 🛠️ 测试工具和依赖

### 测试框架
- **JUnit 4** - 基础测试框架
- **Turbine** - Flow测试库，用于测试StateFlow
- **MockK** - Kotlin Mock框架（已添加，可用于未来扩展）
- **Kotlinx Coroutines Test** - 协程测试支持

### Compose测试
- **androidx.compose.ui.test** - Compose UI测试框架
- **androidx.compose.ui.test.junit4** - Compose测试JUnit4支持

## 🚀 运行测试

### 运行所有单元测试
```bash
./gradlew test
```

### 运行所有集成测试
```bash
./gradlew connectedAndroidTest
```

### 运行特定测试类
在Android Studio中：
1. 右键点击测试文件
2. 选择 "Run 'TestClassName'"

### 运行单个测试方法
在Android Studio中：
1. 点击测试方法左侧的运行图标
2. 或右键点击测试方法，选择 "Run"

## 📊 测试覆盖率

当前测试覆盖：
- ✅ Model层：Content数据模型
- ✅ Model层：ContentRepository
- ✅ Model层：TopicRepository（通过TopicViewModel测试）
- ✅ Model层：CommentRepository（通过CommentViewModel测试）
- ✅ Model层：FavoriteRepository
- ✅ ViewModel层：HomeViewModel（包含话题切换、刷新、加载更多）
- ✅ ViewModel层：TopicViewModel
- ✅ ViewModel层：CommentViewModel
- ✅ ViewModel层：FavoriteViewModel
- ✅ ViewModel层：UserViewModel
- ✅ Util层：ResourceHelper
- ✅ View层：HomeScreen（基础测试）
- ✅ View层：ProfileScreen
- ✅ View层：LoginScreen
- ✅ View层：RegisterScreen

## 📝 测试最佳实践

### 1. 测试命名
使用描述性的测试方法名，格式：`测试场景_预期结果`
```kotlin
@Test
fun `getContentById should return correct content`() {
    // 测试代码
}
```

### 2. Given-When-Then模式
```kotlin
@Test
fun testExample() {
    // Given - 准备测试数据
    val content = Content(...)
    
    // When - 执行被测试的操作
    val result = viewModel.getContentById("1")
    
    // Then - 验证结果
    assertEquals(content, result)
}
```

### 3. 异步测试
使用 `runTest` 和 `delay` 处理异步操作：
```kotlin
@Test
fun `loadContents should populate contents`() = runTest {
    val viewModel = HomeViewModel()
    delay(1000) // 等待异步加载完成
    
    assertTrue(viewModel.contents.value.isNotEmpty())
}
```

### 4. Flow测试
使用 Turbine 测试 StateFlow：
```kotlin
viewModel.contents.test {
    val contents = awaitItem()
    assertTrue(contents.isNotEmpty())
}
```

## 🔍 调试测试

### 查看测试日志
在Android Studio的Run窗口中查看测试输出。

### 调试失败的测试
1. 在测试方法中设置断点
2. 右键点击测试方法，选择 "Debug"
3. 逐步执行代码，查看变量值

## 📈 未来扩展

### 可以添加的测试：
1. **Mock测试**
   - 使用MockK模拟Repository
   - 测试ViewModel的错误处理

2. **UI测试扩展**
   - 测试用户交互（点击、滑动）
   - 测试导航功能
   - 测试视频播放器功能（倍速、音量控制）
   - 测试话题切换功能
   - 测试下拉刷新和上拉加载更多
   - 测试详情页上下切换功能

3. **性能测试**
   - 测试大数据量加载
   - 测试内存泄漏

4. **端到端测试**
   - 测试完整的用户流程
   - 测试页面间导航

## ⚠️ 注意事项

1. **单元测试**运行在JVM上，不能使用Android API
2. **集成测试**需要Android设备或模拟器
3. 测试中的异步操作需要使用 `runTest` 和适当的等待
4. Compose测试需要特定的测试规则和设置

## 📚 参考资源

- [Android Testing Guide](https://developer.android.com/training/testing)
- [JUnit Documentation](https://junit.org/junit4/)
- [Turbine Documentation](https://github.com/cashapp/turbine)
- [Compose Testing](https://developer.android.com/jetpack/compose/testing)

